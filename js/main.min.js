function language(){var l_lang;return l_lang=navigator.userLanguage?navigator.userLanguage:navigator.language?navigator.language:"zh",l_lang.substring(0,2)}function msg(){return"en"==language()?messages.en:messages.zh}function KeyboardInputManager(){this.events={},this.listen()}function Rand(seed){this.m_w=seed,this.m_z=987654321}function GameRecorder(seed){this.reset(seed)}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-container"),this.bestContainer=document.querySelector(".best-container"),this.messageContainer=document.querySelector(".game-message"),this.sharingContainer=document.querySelector(".score-sharing"),this.score=0}function Grid(size,rand){this.size=size,this.cells=[],this.rand=rand,this.build()}function Tile(position,value){this.x=position.x,this.y=position.y,this.value=value||2,this.previousPosition=null,this.mergedFrom=null}function LocalScoreManager(){this.key="bestScore";var supported=this.localStorageSupported();this.storage=supported?window.localStorage:window.fakeStorage}function GameManager(size,InputManager,Actuator,ScoreManager,AudioManager){this.size=size,this.inputManager=new InputManager,this.scoreManager=new ScoreManager,this.actuator=new Actuator,this.audioManager=new AudioManager,this.startTiles=2,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.restart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.inputManager.on("saveName",this.saveName.bind(this)),this.setup()}function XHConn(){var xmlhttp,bComplete=!1;try{xmlhttp=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){try{xmlhttp=new XMLHttpRequest}catch(e){xmlhttp=!1}}}return xmlhttp?(this.connect=function(sURL,sMethod,sVars,fnDone){if(!xmlhttp)return!1;bComplete=!1,sMethod=sMethod.toUpperCase();try{"GET"==sMethod?(xmlhttp.open(sMethod,sURL+"?"+sVars,!0),sVars=""):(xmlhttp.open(sMethod,sURL,!0),xmlhttp.setRequestHeader("Method","POST "+sURL+" HTTP/1.1"),xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded")),xmlhttp.onreadystatechange=function(){4!=xmlhttp.readyState||bComplete||(bComplete=!0,fnDone(xmlhttp))},xmlhttp.send(sVars)}catch(z){return!1}return!0},this):null}function AudioManager(){this.audio=document.getElementById("merge-audio"),this.bigAudio=document.getElementById("big-audio")}function ReplayManager(id){this.interval=100;var that=this;data=get_score(id,function(score){$("#replay-name").text("| Replay:"+score.nickname),$("#replay-name").removeClass("hidden");var countryUrl="http://www.kidlink.org//icons/f0-cn.gif";score.country&&"null"!=score.country&&(countryUrl="http://www.kidlink.org//icons/f0-"+score.country+".gif"),$("#replay-country").attr("src",countryUrl),$("#replay-country").removeClass("hidden"),that.run(score)})}if(messages={en:{SCORE:"SCORE",BEST:"BEST",BOARD:"Leader Board",HIDE_BOARD:"Hide",RETRY:"Try again",GAME_OVER:"Game over",WIN:"You won",CONTINUE:"Continue",POST_NAME:"Submit",POST_NAME_SUCCEED:"Succeed",NAME_PLACEHOLDER:"Your name",MORE:"More...",EMPTY_NICKNAME:"Name can not be empty"},zh:{SCORE:"当前得分",BEST:"最高得分",BOARD:"英雄榜",HIDE_BOARD:"收起榜单",RETRY:"重来",GAME_OVER:"你输了",WIN:"你赢了",CONTINUE:"继续",POST_NAME:"提交",POST_NAME_SUCCEED:"提交成功",NAME_PLACEHOLDER:"贵姓大名",MORE:"更多...",EMPTY_NICKNAME:"昵称不能为空"}},function(){for(var lastTime=0,vendors=["webkit","moz"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}(),KeyboardInputManager.prototype.on=function(event,callback){this.events[event]||(this.events[event]=[]),this.events[event].push(callback)},KeyboardInputManager.prototype.emit=function(event,data){var callbacks=this.events[event];callbacks&&callbacks.forEach(function(callback){callback(data)})},KeyboardInputManager.prototype.listen=function(){var self=this,map={38:0,39:1,40:2,37:3};document.addEventListener("keydown",function(event){var modifiers=event.altKey||event.ctrlKey||event.metaKey||event.shiftKey,mapped=map[event.which];modifiers||(void 0!==mapped&&(event.preventDefault(),self.emit("move",mapped)),32===event.which&&event.preventDefault())});var retry=document.querySelector(".retry-button");retry.addEventListener("click",this.restart.bind(this)),retry.addEventListener("touchend",this.restart.bind(this));var keepPlaying=document.querySelector(".keep-playing-button");keepPlaying.addEventListener("click",this.keepPlaying.bind(this)),keepPlaying.addEventListener("touchend",this.keepPlaying.bind(this));var saveName=document.querySelector(".save-name");saveName.addEventListener("click",this.saveName.bind(this));var touchStartClientX,touchStartClientY,gameContainer=document.getElementsByClassName("game-container")[0];gameContainer.addEventListener("touchstart",function(event){event.touches.length>1||(touchStartClientX=event.touches[0].clientX,touchStartClientY=event.touches[0].clientY)}),gameContainer.addEventListener("touchmove",function(event){event.preventDefault()}),gameContainer.addEventListener("touchend",function(event){if(!(event.touches.length>0)){var dx=event.changedTouches[0].clientX-touchStartClientX,absDx=Math.abs(dx),dy=event.changedTouches[0].clientY-touchStartClientY,absDy=Math.abs(dy);Math.max(absDx,absDy)>10&&self.emit("move",absDx>absDy?dx>0?1:3:dy>0?2:0)}})},KeyboardInputManager.prototype.restart=function(event){event.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(event){event.preventDefault(),this.emit("keepPlaying")},KeyboardInputManager.prototype.saveName=function(event){event.preventDefault(),this.emit("saveName")},Rand.prototype.random=function(){return this.m_z=36969*(65535&this.m_z)+(this.m_z>>16)&4294967295,this.m_w=18e3*(65535&this.m_w)+(this.m_w>>16)&4294967295,((this.m_z<<16)+this.m_w&4294967295)/4294967296+.5},"undefined"!=typeof exports&&(exports.Rand=Rand),GameRecorder.prototype.recordMove=function(direction){this.moves.push(direction)},GameRecorder.prototype.serialize=function(){return{moves:this.moves.join(),seed:this.seed}},GameRecorder.prototype.reset=function(seed){this.moves=[],this.seed=seed},"undefined"!=typeof exports&&(exports.GameRecorder=GameRecorder),HTMLActuator.prototype.actuate=function(grid,metadata){var self=this;window.requestAnimationFrame(function(){self.clearContainer(self.tileContainer),grid.cells.forEach(function(column){column.forEach(function(cell){cell&&self.addTile(cell)})}),self.updateScore(metadata.score),self.updateBestScore(metadata.bestScore),metadata.terminated&&(metadata.over?self.message(!1):metadata.won&&self.message(!0))})},HTMLActuator.prototype.continue=function(){"undefined"!=typeof ga&&ga("send","event","game","restart"),this.clearMessage()},HTMLActuator.prototype.clearContainer=function(container){for(;container.firstChild;)container.removeChild(container.firstChild)},HTMLActuator.prototype.addTile=function(tile){var self=this,wrapper=document.createElement("div"),inner=document.createElement("div"),position=tile.previousPosition||{x:tile.x,y:tile.y},positionClass=this.positionClass(position),classes=["tile","tile-"+tile.value,positionClass];tile.value>2048&&classes.push("tile-super"),this.applyClasses(wrapper,classes),inner.classList.add("tile-inner"),inner.textContent=tile.value,tile.previousPosition?window.requestAnimationFrame(function(){classes[2]=self.positionClass({x:tile.x,y:tile.y}),self.applyClasses(wrapper,classes)}):tile.mergedFrom?(classes.push("tile-merged"),this.applyClasses(wrapper,classes),tile.mergedFrom.forEach(function(merged){self.addTile(merged)})):(classes.push("tile-new"),this.applyClasses(wrapper,classes)),wrapper.appendChild(inner),this.tileContainer.appendChild(wrapper)},HTMLActuator.prototype.applyClasses=function(element,classes){element.setAttribute("class",classes.join(" "))},HTMLActuator.prototype.normalizePosition=function(position){return{x:position.x+1,y:position.y+1}},HTMLActuator.prototype.positionClass=function(position){return position=this.normalizePosition(position),"tile-position-"+position.x+"-"+position.y},HTMLActuator.prototype.updateScore=function(score){this.clearContainer(this.scoreContainer);var difference=score-this.score;if(this.score=score,this.scoreContainer.textContent=this.score,difference>0){var addition=document.createElement("div");addition.classList.add("score-addition"),addition.textContent="+"+difference,this.scoreContainer.appendChild(addition)}},HTMLActuator.prototype.updateBestScore=function(bestScore){this.bestContainer.textContent=bestScore},HTMLActuator.prototype.message=function(won){var type=won?"game-won":"game-over",message=won?msg().WON:msg().GAME_OVER;"undefined"!=typeof ga&&ga("send","event","game","end",type,this.score),this.messageContainer.classList.add(type),this.messageContainer.getElementsByTagName("p")[0].textContent=message,this.clearContainer(this.sharingContainer),"app"==window.shareMode&&this.sharingContainer.appendChild(this.scoreTweetButton())},HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")},HTMLActuator.prototype.scoreTweetButton=function(){var tweet=document.createElement("a");return tweet.classList.add("twitter-share-button"),tweet.setAttribute("href","https://com.nich01as.com/g1024/share?score="+this.score),tweet.textContent="奔走相告，告诉小伙伴！",tweet},Grid.prototype.build=function(){for(var x=0;x<this.size;x++)for(var row=this.cells[x]=[],y=0;y<this.size;y++)row.push(null)},Grid.prototype.randomAvailableCell=function(){var cells=this.availableCells();return cells.length?cells[Math.floor(this.rand.random()*cells.length)]:void 0},Grid.prototype.availableCells=function(){var cells=[];return this.eachCell(function(x,y,tile){tile||cells.push({x:x,y:y})}),cells},Grid.prototype.eachCell=function(callback){for(var x=0;x<this.size;x++)for(var y=0;y<this.size;y++)callback(x,y,this.cells[x][y])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(cell){return!this.cellOccupied(cell)},Grid.prototype.cellOccupied=function(cell){return!!this.cellContent(cell)},Grid.prototype.cellContent=function(cell){return this.withinBounds(cell)?this.cells[cell.x][cell.y]:null},Grid.prototype.insertTile=function(tile){this.cells[tile.x][tile.y]=tile},Grid.prototype.removeTile=function(tile){this.cells[tile.x][tile.y]=null},Grid.prototype.withinBounds=function(position){return position.x>=0&&position.x<this.size&&position.y>=0&&position.y<this.size},"undefined"!=typeof exports&&(exports.Grid=Grid),Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(position){this.x=position.x,this.y=position.y},"undefined"!=typeof exports&&(exports.Tile=Tile),window.fakeStorage={_data:{},setItem:function(id,val){return this._data[id]=String(val)},getItem:function(id){return this._data.hasOwnProperty(id)?this._data[id]:void 0},removeItem:function(id){return delete this._data[id]},clear:function(){return this._data={}}},LocalScoreManager.prototype.localStorageSupported=function(){var testKey="test",storage=window.localStorage;try{return storage.setItem(testKey,"1"),storage.removeItem(testKey),!0}catch(error){return!1}},LocalScoreManager.prototype.get=function(){return this.storage.getItem(this.key)||0},LocalScoreManager.prototype.set=function(score){this.storage.setItem(this.key,score)},"undefined"!=typeof require)var Grid=require("./grid.js").Grid,Tile=require("./tile.js").Tile,Rand=require("./rand.js").Rand,GameRecorder=require("./game_recorder.js").GameRecorder;GameManager.prototype.restart=function(){this.actuator.continue(),this.setup()},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continue()},GameManager.prototype.setCountry=function(country){console.log("COUNTRY: "+country),this.country=country},GameManager.prototype.saveName=function(){var nameInput=document.querySelector(".name-input");nameInput.value?this.postScore(nameInput.value,this.getMetadata()):window.alert(msg().EMPTY_NICKNAME)},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying?!0:!1},GameManager.prototype.setup=function(s){var seed=s||Math.round(1e4*Date.now()+1e4*Math.random());this.gameRecorder=new GameRecorder(seed),this.rand=new Rand(seed),this.grid=new Grid(this.size,this.rand),this.score=0,this.maxNumber=2,this.goal=2048,this.over=!1,this.won=!1,this.keepPlaying=!1,this.isReplay=!1,this.addStartTiles(),this.actuate()},GameManager.prototype.setReplay=function(r){this.isReplay=r},GameManager.prototype.setGoal=function(goal){this.goal=goal},GameManager.prototype.addStartTiles=function(){for(var i=0;i<this.startTiles;i++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var r=this.rand.random(),value=.9>r?2:4,tile=new Tile(this.grid.randomAvailableCell(),value);this.grid.insertTile(tile)}},GameManager.prototype.getMetadata=function(){return{score:this.score,over:this.over,won:this.won,bestScore:this.scoreManager.get(),terminated:this.isGameTerminated(),gameRecorder:this.gameRecorder,maxNumber:this.maxNumber,isReplay:this.isReplay}},GameManager.prototype.actuate=function(){this.scoreManager.get()<this.score&&this.scoreManager.set(this.score),this.actuator.actuate(this.grid,this.getMetadata())},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(x,y,tile){tile&&(tile.mergedFrom=null,tile.savePosition())})},GameManager.prototype.moveTile=function(tile,cell){this.grid.cells[tile.x][tile.y]=null,this.grid.cells[cell.x][cell.y]=tile,tile.updatePosition(cell)},GameManager.prototype.move=function(direction){var self=this;if(this.gameRecorder.recordMove(direction),!this.isGameTerminated()){var cell,tile,vector=this.getVector(direction),traversals=this.buildTraversals(vector),moved=!1,largest=0;this.prepareTiles(),this.audioManager.pause(),traversals.x.forEach(function(x){traversals.y.forEach(function(y){if(cell={x:x,y:y},tile=self.grid.cellContent(cell)){var positions=self.findFarthestPosition(cell,vector),next=self.grid.cellContent(positions.next);if(next&&next.value===tile.value&&!next.mergedFrom){var merged=new Tile(positions.next,2*tile.value);merged.value>self.maxNumber&&(self.maxNumber=merged.value),largest=largest>merged.value?largest:merged.value,merged.mergedFrom=[tile,next],self.grid.insertTile(merged),self.grid.removeTile(tile),tile.updatePosition(positions.next),self.score+=merged.value,merged.value==self.goal}else self.moveTile(tile,positions.farthest);self.positionsEqual(cell,tile)||(moved=!0)}})}),this.audioManager.play(largest),moved&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},GameManager.prototype.getVector=function(direction){var map={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return map[direction]},GameManager.prototype.buildTraversals=function(vector){for(var traversals={x:[],y:[]},pos=0;pos<this.size;pos++)traversals.x.push(pos),traversals.y.push(pos);return 1===vector.x&&(traversals.x=traversals.x.reverse()),1===vector.y&&(traversals.y=traversals.y.reverse()),traversals},GameManager.prototype.findFarthestPosition=function(cell,vector){var previous;do previous=cell,cell={x:previous.x+vector.x,y:previous.y+vector.y};while(this.grid.withinBounds(cell)&&this.grid.cellAvailable(cell));return{farthest:previous,next:cell}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var tile,self=this,x=0;x<this.size;x++)for(var y=0;y<this.size;y++)if(tile=this.grid.cellContent({x:x,y:y}))for(var direction=0;4>direction;direction++){var vector=self.getVector(direction),cell={x:x+vector.x,y:y+vector.y},other=self.grid.cellContent(cell);if(other&&other.value===tile.value)return!0}return!1},GameManager.prototype.positionsEqual=function(first,second){return first.x===second.x&&first.y===second.y},GameManager.prototype.postScore=function(name,metadata){post_json("scores",{nickname:name,score:metadata.score,max_number:metadata.maxNumber,payload:metadata.gameRecorder.serialize(),country:this.country},function(status){status&&(window.alert(msg().POST_NAME_SUCCEED),window.location.assign("/?restart=1"))})},"undefined"!=typeof exports&&(exports.GameManager=GameManager),post_json=function(path,obj,cb){xmlhttp=new XMLHttpRequest;var url="/"+path;xmlhttp.open("POST",url,!0),xmlhttp.setRequestHeader("Content-type","application/json"),xmlhttp.onload=function(){cb(this.status)},xmlhttp.send(JSON.stringify(obj))},add_row=function(tr,c1,c2){var td=document.createElement("td");return setContent(td,c1),tr.appendChild(td),td=document.createElement("td"),setContent(td,c2),tr.appendChild(td),tr},load_score=function(offset){var myConn=new XHConn;if(myConn){var fnWhenDone=function(oXML){for(var scoreObject=JSON.parse(oXML.responseText),rank=document.getElementById("rank-table"),i=0;i<scoreObject.scores.length;i++){var tr=document.createElement("tr"),td=document.createElement("td");td.className="rank-td";var d1=document.createElement("div");d1.className="rank-tile tile tile-"+scoreObject.scores[i].max_number;var d2=document.createElement("div");d2.className="rank-tile tile-inner",d1.appendChild(d2),setContent(d2,offset+i+1),td.appendChild(d1),tr.appendChild(td),add_row(tr,scoreObject.scores[i].nickname,scoreObject.scores[i].score),rank.appendChild(tr)}};myConn.connect("scores","GET","offset="+offset,fnWhenDone)}},get_score=function(id,cb){var myConn=new XHConn;myConn&&myConn.connect("score","GET","id="+id,function(oXML){var scoreObject=JSON.parse(oXML.responseText).score;scoreObject.payload=JSON.parse(scoreObject.payload),cb(scoreObject)})},setContent=function(el,text){"undefined"!=el.textContent?el.textContent=text:el.innerText=text},AudioManager.prototype.pause=function(){},AudioManager.prototype.play=function(){},ReplayManager.prototype.run=function(score){function MockKeyboardInputManager(){this.on=function(){}}function MockScoreManager(){this.get=function(){},this.set=function(){}}var gm=new GameManager(4,MockKeyboardInputManager,HTMLActuator,MockScoreManager,AudioManager);gm.setup(score.seed),gm.setReplay(!0);var moves=score.payload.moves.split(","),that=this,cb=function(moves,idx){idx<moves.length&&(gm.move(moves[idx]),that.timerId=window.setTimeout(function(){cb(moves,++idx)},that.interval))};this.move=cb,cb(moves,0)},ReplayManager.prototype.pause=function(){window.clearTimeout(this.timerId)},ReplayManager.prototype.resume=function(){this.start=new Date;var that=this;this.timerId=window.setTimeout(function(){that.move,that.interval})},ReplayManager.prototype.accelerate=function(){this.interval/=2},ReplayManager.prototype.decelerate=function(){this.interval*=2},window.requestAnimationFrame(function(){var re=/replay=(\d+)/,str=window.location.search.substring(1),arr=re.exec(str);if(arr)document.querySelector(".best-container").style.display="none",new ReplayManager(arr[1]);else{var gm=new GameManager(4,KeyboardInputManager,HTMLActuator,LocalScoreManager,AudioManager);$.get("http://ipinfo.io",function(r){gm.setCountry(r.country.toLowerCase())},"jsonp")}var toHide;window.isApp=navigator.userAgent.indexOf("2048-android")>=0||navigator.userAgent.indexOf("2048-ios")>=0,isApp?(toHide=document.getElementsByClassName("web-share"),window.shareMode="app"):(toHide=document.getElementsByClassName("app-share"),window.shareMode="web");for(var i=0;i<toHide.length;i++)toHide[i].style.display="none";var explanation=document.getElementsByClassName("game-explanation"),showingExp=!1,expLink=document.getElementById("exp-link");document.getElementById("how-to").onclick=function(){showingExp=!showingExp;for(var i=0;i<explanation.length;i++)explanation[i].style.display=showingExp?"block":"none";expLink.innerText=showingExp?"收起说明":"玩法说明"};var showingTip=!1,gameTips=document.getElementsByClassName("game-tip"),tipLink=document.getElementById("tip-link");document.getElementById("game-tip-toggle").onclick=function(){showingTip=!showingTip;for(var i=0;i<gameTips.length;i++)gameTips[i].style.display=showingTip?"block":"none";tipLink.innerText=showingTip?"收起攻略":"高分技巧"};var scoreManager=new LocalScoreManager;if("zh"==language()&&bShare.addEntry({title:"#Go2048# 一个停不下来的游戏！",url:"http://go2048.com",summary:"我的最高得分是"+scoreManager.get()+"!",pic:"http://go2048.com/2048_files/og_image.png"}),navigator.userAgent.indexOf("Android")>=0){var playStoreEls=document.getElementsByClassName("play-store");playStoreEls[0].style.display="block"}{var offset=(document.getElementById("rank-link"),0);document.getElementById("rank-table")}if(document.getElementById("rank-more").onclick=function(){load_score(offset),offset+=10},"zh"!=language()){tipLink.style.display="none",expLink.style.display="none",document.getElementById("game-tip-toggle").style.display="none",document.getElementById("how-to").style.display="none",document.getElementById("wechat").style.display="none",document.getElementById("bshare").style.display="none";var tt=document.getElementById("tweet");tt.href="https://twitter.com/go2048",tt.innerHTML="@go2048"}else document.getElementById("bshare").innerHTML='<a class="bshareDiv" href="http://www.bshare.cn/share">分享按钮</a><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#uuid=&amp;style=3&amp;fs=4&amp;textcolor=#fff&amp;bgcolor=#9C3&amp;text=分享到&amp;pophcol=1"></script>';document.getElementById("rank-link").innerHTML=msg().BOARD,document.getElementById("rank-more").innerHTML=msg().MORE,document.querySelector(".keep-playing-button").innerHTML=msg().CONTINUE,document.querySelector(".retry-button").innerHTML=msg().RETRY,document.querySelector(".save-name").innerHTML=msg().POST_NAME});